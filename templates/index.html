{% extends 'base.html' %}
{% block content %}
<div class="chat-container">
  {% if not history %}
  <div class="welcome-message">
    <h1 class="text-center mb-4">Rajagiri College Chatbot</h1>
    <p class="text-center text-secondary">Ask about admissions, departments, scholarships, or campus life.</p>
    
    <div class="suggestions">
      <div class="suggestion-card" onclick="setQuestion(this)">
        <i class="fas fa-graduation-cap"></i>
        <span>What are the admission requirements for CS?</span>
      </div>
      <div class="suggestion-card" onclick="setQuestion(this)">
        <i class="fas fa-book"></i>
        <span>Tell me about the English department</span>
      </div>
      <div class="suggestion-card" onclick="setQuestion(this)">
        <i class="fas fa-rupee-sign"></i>
        <span>What scholarships are available?</span>
      </div>
      <div class="suggestion-card" onclick="setQuestion(this)">
        <i class="fas fa-home"></i>
        <span>Describe campus facilities</span>
      </div>
    </div>
  </div>
  {% endif %}
  
  <div class="chat-messages" id="chatMessages">
    {% for msg in history %}
    <div class="message {{ 'user-message' if msg.role == 'user' else 'bot-message' }}">
      <div class="message-avatar">
        {% if msg.role == 'user' %}
          {% if user_data and user_data.user_info and user_data.user_info.picture %}
            <img src="{{ user_data.user_info.picture }}" alt="User" class="rounded-circle">
          {% else %}
            <i class="fas fa-user"></i>
          {% endif %}
        {% else %}
          <img src="{{ url_for('static', filename='images/rajagiri-logo.png') }}" alt="Rajagiri Logo">
        {% endif %}
      </div>
      <div class="message-content">
        {{ msg.content | safe }}
        
        {% if msg.role == 'assistant' %}
        <div class="message-actions"
     data-chat="{{ current_chat }}"
     data-index="{{ loop.index0 }}">
        <button class="btn-action" onclick="rateFromButton(this, 'like')" title="Like">
          <i class="far fa-thumbs-up"></i>
        </button>
        <button class="btn-action" onclick="rateFromButton(this, 'dislike')" title="Dislike">
          <i class="far fa-thumbs-down"></i>
        </button>
      </div>
        {% endif %}
      </div>
    </div>
    {% endfor %}

    <div id="loadingIndicator" style="display: none;">
      <div class="message bot-message">
        <div class="message-avatar">
          <img src="{{ url_for('static', filename='images/rajagiri-logo.png') }}" alt="Rajagiri Logo">
        </div>
        <div class="message-content">
          <div class="typing-indicator">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="input-container">
    <form method="POST" id="chatForm" class="d-flex gap-2 align-items-center">
      <div class="input-group">
        <input name="question" id="userInput" class="form-control" placeholder="Type your query..." autocomplete="off" required>
        <button class="btn btn-send" type="submit">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </form>
    <div class="disclaimer">
      <small class="text-muted">Rajagiri Chatbot may produce inaccurate information. Verify important details.</small>
    </div>
  </div>
</div>

<script>
  function setQuestion(element) {
    document.getElementById('userInput').value = element.querySelector('span').textContent;
    document.getElementById('userInput').focus();
  }

  document.getElementById('chatForm').addEventListener('submit', function () {
    document.getElementById('loadingIndicator').style.display = 'block';
    scrollToBottom();
  });

  function scrollToBottom() {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.scrollTo({
      top: chatMessages.scrollHeight,
      behavior: 'smooth'
    });
  }

  function copyToClipboard(button) {
    const messageContent = button.closest('.message-content');
    const textToCopy = messageContent.innerText.replace(/CopyLikeDislike/g, '').trim();

    navigator.clipboard.writeText(textToCopy).then(() => {
      const icon = button.querySelector('i');
      icon.classList.remove('far', 'fa-copy');
      icon.classList.add('fas', 'fa-check');

      setTimeout(() => {
        icon.classList.remove('fas', 'fa-check');
        icon.classList.add('far', 'fa-copy');
      }, 2000);
    });
  }

  function rateMessage(button, action, chatId, messageIndex) {
    fetch('/rate-message', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        chatId: chatId,
        messageIndex: messageIndex,
        action: action
      })
    }).then(response => {
      if (response.ok) {
        const icon = button.querySelector('i');
        if (action === 'like') {
          icon.classList.remove('far');
          icon.classList.add('fas');
          const dislikeBtn = button.nextElementSibling;
          if (dislikeBtn) {
            dislikeBtn.querySelector('i').classList.remove('fas');
            dislikeBtn.querySelector('i').classList.add('far');
          }
        } else {
          icon.classList.remove('far');
          icon.classList.add('fas');
          const likeBtn = button.previousElementSibling;
          if (likeBtn) {
            likeBtn.querySelector('i').classList.remove('fas');
            likeBtn.querySelector('i').classList.add('far');
          }
        }
      }
    });
  }

  scrollToBottom();
</script>
{% endblock %}
